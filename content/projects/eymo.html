<div class="eymo-container">
	<style>
		.eymo-container {
			max-width: 1000px;
			margin: 0 auto;
			padding: 20px;
			font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
		}
		
		.eymo-header {
			text-align: center;
			margin-bottom: 30px;
		}
		
		.eymo-start-button {
			background: #007bff;
			color: white;
			border: none;
			padding: 12px 24px;
			font-size: 16px;
			border-radius: 6px;
			cursor: pointer;
			transition: background 0.2s;
		}
		
		.eymo-start-button:hover {
			background: #0056b3;
		}
		
		.eymo-main {
			display: none;
		}
		
		.eymo-main.visible {
			display: block;
		}
		
		.eymo-loading {
			display: none;
			text-align: center;
			padding: 40px;
			font-size: 18px;
			color: #666;
		}
		
		.eymo-loading.visible {
			display: block;
		}
		
		.eymo-spinner {
			display: inline-block;
			width: 20px;
			height: 20px;
			border: 3px solid #f3f3f3;
			border-top: 3px solid #007bff;
			border-radius: 50%;
			animation: spin 1s linear infinite;
			margin-right: 10px;
		}
		
		@keyframes spin {
			0% { transform: rotate(0deg); }
			100% { transform: rotate(360deg); }
		}
		
		.eymo-canvas-container {
			text-align: center;
			margin-bottom: 30px;
		}
		
		#canvas {
			border: 2px solid #ddd;
			border-radius: 8px;
			max-width: 100%;
			height: auto;
		}
		
		.eymo-controls {
			display: grid;
			gap: 20px;
			margin-bottom: 30px;
		}
		
		.eymo-command-section {
			background: #f8f9fa;
			padding: 20px;
			border-radius: 8px;
			border: 1px solid #e9ecef;
		}
		
		.eymo-command-label {
			display: block;
			font-weight: 600;
			margin-bottom: 8px;
			color: #333;
		}
		
		#cmd {
			width: 100%;
			min-height: 100px;
			padding: 12px;
			border: 1px solid #ddd;
			border-radius: 6px;
			font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
			font-size: 14px;
			resize: vertical;
			background: white;
		}
		
		#cmd:focus {
			outline: none;
			border-color: #007bff;
			box-shadow: 0 0 0 2px rgba(0, 123, 255, 0.25);
		}
		
		.eymo-buttons {
			display: flex;
			gap: 12px;
			justify-content: center;
			flex-wrap: wrap;
		}
		
		.eymo-button {
			padding: 10px 20px;
			border: none;
			border-radius: 6px;
			cursor: pointer;
			font-size: 14px;
			font-weight: 500;
			transition: all 0.2s;
		}
		
		.eymo-button.primary {
			background: #28a745;
			color: white;
		}
		
		.eymo-button.primary:hover {
			background: #218838;
		}
		
		.eymo-button.secondary {
			background: #6c757d;
			color: white;
		}
		
		.eymo-button.secondary:hover {
			background: #545b62;
		}
		
		.eymo-button.danger {
			background: #dc3545;
			color: white;
		}
		
		.eymo-button.danger:hover {
			background: #c82333;
		}
		
		.eymo-sample-configs {
			background: #f8f9fa;
			padding: 20px;
			border-radius: 8px;
			border: 1px solid #e9ecef;
			margin-bottom: 20px;
		}
		
		.eymo-sample-label {
			display: block;
			font-weight: 600;
			margin-bottom: 12px;
			color: #333;
		}
		
		.eymo-sample-buttons {
			display: grid;
			grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
			gap: 10px;
		}
		
		.eymo-sample-button {
			background: #17a2b8;
			color: white;
			border: none;
			padding: 8px 16px;
			border-radius: 6px;
			cursor: pointer;
			font-size: 13px;
			font-weight: 500;
			transition: all 0.2s;
		}
		
		.eymo-sample-button:hover {
			background: #138496;
		}
		
		@media (max-width: 768px) {
			.eymo-container {
				padding: 10px;
			}
			
			.eymo-buttons {
				flex-direction: column;
			}
			
			.eymo-button {
				width: 100%;
			}
		}
	</style>
	
	<div class="eymo-header">
		<button id="start" class="eymo-start-button">Load Eymo</button>
	</div>
	
	<div id="loading" class="eymo-loading">
		<div class="eymo-spinner"></div>
		Loading Eymo WASM module...
	</div>
	
	<div id="main" class="eymo-main">
		<div class="eymo-canvas-container">
			<canvas id="canvas" width="640" height="480"></canvas>
		</div>
		
		<div class="eymo-controls">
			<div class="eymo-sample-configs">
				<label class="eymo-sample-label">Sample Configurations:</label>
				<div id="sample-buttons" class="eymo-sample-buttons">
					<!-- Sample buttons will be generated by JavaScript -->
				</div>
			</div>
			
			<div class="eymo-command-section">
				<label for="cmd" class="eymo-command-label">Eymo Command:</label>
				<textarea id="cmd" placeholder="Enter your Eymo commands here..."></textarea>
			</div>
			
			<div class="eymo-buttons">
				<button id="submit" class="eymo-button primary">Update Command</button>
				<button id="play" class="eymo-button secondary">Play</button>
				<button id="stop" class="eymo-button danger">Stop</button>
			</div>
		</div>
	</div>

	<script type="module">
		console.log('Loading wasm...');
		import init, { State } from './eymo_wasm.js';

		const sampleConfigs = {
			faceParty: {
				label: "Face Party",
				config: `leye: scale(4), saturate(1.2), brighten(1.4), spin(0.3), drift(10)
reye: scale(4), saturate(1.2), brighten(1.4), spin(-0.5), drift(10, 225)
mouth: copy_to(reye_region+1), scale(1.5), brighten(1.2), saturate(1.3)
leye_region: swap_with(mouth+1), scale(1.5), brighten(1.2), saturate(1.3)
`,
			},
			tileEye: {
				label: "Tiled Eye",
				config: `leye: tile, channels(1.1, 0.8, 1.1)`
			},
			swapFaces: {
				label: "Swap Faces (2+ People)",
				config: `face: copy_to(face+1), scale(1.5)`,
			},
			swapFaceParts: {
				label: "Swap Face Parts (2+ People)",
				config: `mouth: copy_to(mouth+1), scale(2.0), saturate(1.3), brighten(1.2)
leye_region+1: copy_to(leye_region), scale(1.3), saturate(1.3), brighten(1.2)
reye_region+2: copy_to(reye_region), scale(1.3), saturate(1.3), brighten(1.2)
`,
			},
		}

		// Generate sample config buttons
		function generateSampleButtons() {
			const sampleButtonsContainer = document.getElementById("sample-buttons");
			const cmdTextarea = document.getElementById("cmd");
			
			Object.entries(sampleConfigs).forEach(([key, config]) => {
				const button = document.createElement("button");
				button.className = "eymo-sample-button";
				button.textContent = config.label;
				button.addEventListener("click", () => {
					cmdTextarea.value = config.config;
					console.log(`Loaded sample config: ${config.label}`);
					let submit = document.getElementById("submit");
					submit.click();
				});
				sampleButtonsContainer.appendChild(button);
			});
		}

		async function run() {
			console.log("Initializing wasm...");
			
			// Show loading state
			const loading = document.getElementById("loading");
			const main = document.getElementById("main");
			const startButton = document.getElementById("start");
			
			startButton.style.display = "none";
			loading.classList.add("visible");
			
			try {
				await init();

				let textArea = document.getElementById("cmd");
				textArea.value = sampleConfigs.faceParty.config;
				console.log("Initializing 'state' with cmd", textArea.value);

				let thing = await new State("canvas", textArea.value);

				let submit = document.getElementById("submit");
				submit.addEventListener('click', async () => {
					console.log("Updating command to", textArea.value);
					await thing.set_cmd(textArea.value);
					console.log("Command updated.");
				});

				let play = document.getElementById("play");
				play.addEventListener('click', async () => {
					console.log("starting");
					await thing.start();
				});
				
				let stop = document.getElementById("stop");
				stop.addEventListener('click', async () => {
					console.log("stopping");
					await thing.stop();
				});

				thing.start();

				// Hide loading and show main interface
				loading.classList.remove("visible");
				main.classList.add("visible");

				// Generate sample config buttons
				generateSampleButtons();

				setTimeout(() => {
					console.log("Updating canvas width...");
					let canvas = document.getElementById("canvas");
					canvas.width = 1000;
				}, 10000);
			} catch (error) {
				console.error("Failed to initialize Eymo:", error);
				loading.innerHTML = '<div style="color: #dc3545;">Failed to load Eymo. Please try again.</div>';
				setTimeout(() => {
					loading.classList.remove("visible");
					startButton.style.display = "inline-block";
				}, 3000);
			}
		}

		let start = document.getElementById("start");
		start.addEventListener("click", () => {
			console.log("clicked start!");
			run();
		});
	</script>
</div>
